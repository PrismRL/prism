<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<template id="tmpl_gotoTop"><div id="gotoTop">
  <button>Back to top</button>
</div></template>
    <title>Taking Flight &#8212; Prism  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=266695fe" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/lua.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/terminal.css?v=cab5505d" />
    <link rel="stylesheet" type="text/css" href="../_static/goto-top/style.css?v=c152bd81" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/goto-top/main.js?v=69fc67a6"></script>
    <link rel="icon" href="../_static/prism.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Starting Fights" href="part3.html" />
    <link rel="prev" title="Getting started" href="part1.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="taking-flight">
<h1>Taking Flight<a class="headerlink" href="#taking-flight" title="Link to this heading">¶</a></h1>
<p>Unfortunately for kobolds, they can’t fly. In this section of the tutorial we’re going to
create a <a class="reference internal" href="../reference/prism/core/system.html#lua-System" title="System"><code class="xref lua lua-class docutils literal notranslate"><span class="pre">System</span></code></a> that listens for the end of an actor’s turn, and sends things
falling into the void below if they’re on a pit but unable to fly.</p>
<p>First we’ll need to create a component we’ll put on cells to indicate they’re a place you
can fall.</p>
<section id="creating-the-void-component">
<h2>Creating the Void Component<a class="headerlink" href="#creating-the-void-component" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">modules/MyGame/components</span></code></p></li>
<li><p>Create a new file called <code class="docutils literal notranslate"><span class="pre">void.lua</span></code></p></li>
</ol>
<p>Put the following into <code class="docutils literal notranslate"><span class="pre">void.lua</span></code>:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">--- @class Void : Component</span>
<span class="kd">local</span> <span class="n">Void</span> <span class="o">=</span> <span class="n">prism</span><span class="p">.</span><span class="n">Component</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;Void&quot;</span><span class="p">)</span>
<span class="n">Void</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Void&quot;</span>

<span class="kr">return</span> <span class="n">Void</span>
</pre></div>
</div>
<p>This is a simple tag component that marks tiles where actors can fall if they don’t have an allowed movement type.</p>
</section>
<section id="adding-void-to-our-pit">
<h2>Adding Void to Our Pit<a class="headerlink" href="#adding-void-to-our-pit" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">modules/MyGame/cells/pit.lua</span></code></p></li>
</ol>
<p>Add the following line to its components:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">prism</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="n">Void</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="creating-the-fall-action">
<h2>Creating the Fall Action<a class="headerlink" href="#creating-the-fall-action" title="Link to this heading">¶</a></h2>
<p>Next we’re going to create an Action that encapsulates the act of falling to your doom.</p>
<ol class="arabic simple">
<li><p>Navigate to the <code class="docutils literal notranslate"><span class="pre">modules/MyGame/actions</span></code> directory.</p></li>
<li><p>Create a new file called <code class="docutils literal notranslate"><span class="pre">fall.lua</span></code>.</p></li>
</ol>
<p>Write the following into <code class="docutils literal notranslate"><span class="pre">fall.lua</span></code>:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">--- @class Fall : Action</span>
<span class="kd">local</span> <span class="n">Fall</span> <span class="o">=</span> <span class="n">prism</span><span class="p">.</span><span class="n">Action</span><span class="p">:</span><span class="n">extend</span> <span class="s2">&quot;Fall&quot;</span>

<span class="c1">--- @param level Level</span>
<span class="kr">function</span> <span class="nc">Fall</span><span class="p">:</span><span class="nf">_canPerform</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">:</span><span class="n">getPosition</span><span class="p">():</span><span class="n">decompose</span><span class="p">()</span>
   <span class="kd">local</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">level</span><span class="p">:</span><span class="n">getCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

   <span class="c1">-- We can only fall on cells that are voids.</span>
   <span class="kr">if</span> <span class="ow">not</span> <span class="n">cell</span><span class="p">:</span><span class="n">hasComponent</span><span class="p">(</span><span class="n">prism</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="n">Void</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kc">false</span> <span class="kr">end</span>

   <span class="kd">local</span> <span class="n">cellMask</span> <span class="o">=</span> <span class="n">cell</span><span class="p">:</span><span class="n">getCollisionMask</span><span class="p">()</span>
   <span class="kd">local</span> <span class="n">mover</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">:</span><span class="n">getComponent</span><span class="p">(</span><span class="n">prism</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="n">Mover</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mover</span> <span class="ow">and</span> <span class="n">mover</span><span class="p">.</span><span class="n">mask</span> <span class="ow">or</span> <span class="mi">0</span> <span class="c1">-- default to the immovable mask</span>

   <span class="c1">-- We have a Void component on the cell. If the actor CAN&#39;T move here</span>
   <span class="c1">-- then they fall.</span>
   <span class="kr">return</span> <span class="ow">not</span> <span class="n">prism</span><span class="p">.</span><span class="n">Collision</span><span class="p">.</span><span class="n">checkBitmaskOverlap</span><span class="p">(</span><span class="n">cellMask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">--- @param level Level</span>
<span class="kr">function</span> <span class="nc">Fall</span><span class="p">:</span><span class="nf">_perform</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
   <span class="n">level</span><span class="p">:</span><span class="n">removeActor</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">)</span> <span class="c1">-- into the depths with you!</span>
<span class="kr">end</span>

<span class="kr">return</span> <span class="n">Fall</span>
</pre></div>
</div>
<p>Let’s break it down.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">Fall</span> <span class="o">=</span> <span class="n">prism</span><span class="p">.</span><span class="n">Action</span><span class="p">:</span><span class="n">extend</span> <span class="s2">&quot;Fall&quot;</span>
</pre></div>
</div>
<p>We create a Fall action.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nc">Fall</span><span class="p">:</span><span class="nf">_canPerform</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">:</span><span class="n">getPosition</span><span class="p">():</span><span class="n">decompose</span><span class="p">()</span>
   <span class="kd">local</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">level</span><span class="p">:</span><span class="n">getCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

   <span class="c1">-- We can only fall on cells that are voids.</span>
   <span class="kr">if</span> <span class="ow">not</span> <span class="n">cell</span><span class="p">:</span><span class="n">hasComponent</span><span class="p">(</span><span class="n">prism</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="n">Void</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kc">false</span> <span class="kr">end</span>
</pre></div>
</div>
<p>We define Fall’s <code class="docutils literal notranslate"><span class="pre">_canPerform</span></code> this is the inner private function to canPerform which you’ve
used for controlling kobolds and the player. We check if the cell the actor is standing on
has the void component, and if it doesn’t the actor can’t fall.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span>   <span class="kd">local</span> <span class="n">cellMask</span> <span class="o">=</span> <span class="n">cell</span><span class="p">:</span><span class="n">getCollisionMask</span><span class="p">()</span>
   <span class="kd">local</span> <span class="n">mover</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">:</span><span class="n">getComponent</span><span class="p">(</span><span class="n">prism</span><span class="p">.</span><span class="n">components</span><span class="p">.</span><span class="n">Mover</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mover</span> <span class="ow">and</span> <span class="n">mover</span><span class="p">.</span><span class="n">mask</span> <span class="ow">or</span> <span class="mi">0</span> <span class="c1">-- default to the immovable mask</span>

   <span class="c1">-- We have a Void component on the cell. If the actor CAN&#39;T move here</span>
   <span class="c1">-- then they fall.</span>
   <span class="kr">return</span> <span class="ow">not</span> <span class="n">prism</span><span class="p">.</span><span class="n">Collision</span><span class="p">.</span><span class="n">checkBitmaskOverlap</span><span class="p">(</span><span class="n">cellMask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Now that we’ve checked if the cell is a void we check if the actor can stands there.
If the cell is a void, and the actor can’t stand there off to depths they go!</p>
<p>With all that out the way let’s add the Fall action’s _perform.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">--- @param level Level</span>
<span class="kr">function</span> <span class="nc">Fall</span><span class="p">:</span><span class="nf">_perform</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
   <span class="n">level</span><span class="p">:</span><span class="n">removeActor</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">owner</span><span class="p">)</span> <span class="c1">-- into the depths with you!</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>This one’s simple, we remove the floating actor from the level.</p>
</section>
<section id="triggering-fall-with-a-system">
<h2>Triggering Fall With a System<a class="headerlink" href="#triggering-fall-with-a-system" title="Link to this heading">¶</a></h2>
<p>Okay so we’ve got the fall action done, but this isn’t exactly something
most actors are doing willingly. Kobolds aren’t exactly volunteering to fall into the void.</p>
<p>Let’s create a System to listen in and make sure things fall when they ought to.</p>
<ol class="arabic simple">
<li><p>Navigate to the <code class="docutils literal notranslate"><span class="pre">modules/MyGame/</span></code> directory.</p></li>
<li><p>Create a new folder called <code class="docutils literal notranslate"><span class="pre">systems</span></code>.</p></li>
<li><p>Create a new file in that folder named <code class="docutils literal notranslate"><span class="pre">fallsystem.lua</span></code></p></li>
</ol>
<p>Add the following code:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">--- @class FallSystem : System</span>
<span class="kd">local</span> <span class="n">FallSystem</span> <span class="o">=</span> <span class="n">prism</span><span class="p">.</span><span class="n">System</span><span class="p">:</span><span class="n">extend</span> <span class="s2">&quot;FallSystem&quot;</span>


<span class="c1">--- @param level Level</span>
<span class="c1">--- @param actor Actor</span>
<span class="kr">function</span> <span class="nc">FallSystem</span><span class="p">:</span><span class="nf">onMove</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">fall</span> <span class="o">=</span> <span class="n">prism</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="n">Fall</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

   <span class="kr">if</span> <span class="n">fall</span><span class="p">:</span><span class="n">canPerform</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="kr">then</span>
      <span class="n">level</span><span class="p">:</span><span class="n">performAction</span><span class="p">(</span><span class="n">fall</span><span class="p">)</span>
   <span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">return</span> <span class="n">FallSystem</span>
</pre></div>
</div>
<p>When an actor moves we check if it should fall when it reaches it’s destination. We’re
hooking into <a class="reference internal" href="../reference/prism/core/system.html#lua-System.onMove" title="System.onMove"><code class="xref lua lua-func docutils literal notranslate"><span class="pre">System:onMove()</span></code></a> which is triggered by Level whenever <code class="xref lua lua-func docutils literal notranslate"><span class="pre">Level:moveActor</span></code>
is called.</p>
<p>See <a class="reference internal" href="../reference/prism/core/system.html#lua-System" title="System"><code class="xref lua lua-class docutils literal notranslate"><span class="pre">System</span></code></a> for a listing of events you can hook into!</p>
</section>
<section id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Link to this heading">¶</a></h2>
<p>With our FallSystem in place, kobolds and other unfortunate creatures will now tumble
into the void if they end their turn standing on a pit they can’t fly over.
We’ve used components to tag dangerous tiles, actions to represent involuntary movement,
and systems to enforce game logic based on actor movement.</p>
<p>In the next section of the tutorial, we’ll dive into something a little more active:
combat. We’ll set up a health component, and teach actors how to attack.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/prism.png" alt="Logo" />
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=prismrl&repo=prism&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture-primer.html">Prism’s Architecture: A Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conventions.html">Conventions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-tos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-tos/collision.html">Collision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-tos/inventory.html">Inventory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-tos/query.html">Queries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Making a roguelike</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="part1.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Taking Flight</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-the-void-component">Creating the Void Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-void-to-our-pit">Adding Void to Our Pit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-the-fall-action">Creating the Fall Action</a></li>
<li class="toctree-l2"><a class="reference internal" href="#triggering-fall-with-a-system">Triggering Fall With a System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wrapping-up">Wrapping Up</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="part3.html">Starting Fights</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/prism/index.html">Prism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/spectrum/index.html">Spectrum</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="part1.html" title="previous chapter">Getting started</a></li>
      <li>Next: <a href="part3.html" title="next chapter">Starting Fights</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Matthew Blanchard, LJNIC.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/making-a-roguelike/part2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>